<!DOCTYPE html>  <html> <head>   <title>watchr.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               watchr.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Watchr</span> <span class="o">is</span> <span class="nx">used</span> <span class="nx">to</span> <span class="nx">be</span> <span class="nx">nofitied</span> <span class="k">when</span> <span class="nx">a</span> <span class="nx">change</span> <span class="nx">happens</span> <span class="nx">to</span><span class="p">,</span> <span class="o">or</span> <span class="nx">within</span> <span class="nx">a</span> <span class="nx">directory</span><span class="p">.</span>
<span class="nx">You</span> <span class="nx">will</span> <span class="o">not</span> <span class="nx">be</span> <span class="nx">notified</span> <span class="nx">what</span> <span class="nx">file</span> <span class="nx">was</span> <span class="nx">changed</span><span class="p">,</span> <span class="o">or</span> <span class="nx">how</span> <span class="nx">it</span> <span class="nx">was</span> <span class="nx">changed</span><span class="p">.</span>
<span class="nx">It</span> <span class="nx">will</span> <span class="nx">track</span> <span class="k">new</span> <span class="nx">files</span> <span class="o">and</span> <span class="nx">their</span> <span class="nx">changes</span> <span class="nx">too</span><span class="p">,</span> <span class="o">and</span> <span class="nx">remove</span> <span class="nx">listeners</span> <span class="k">for</span> <span class="nx">deleted</span> <span class="nx">files</span> <span class="nx">appropriatly</span><span class="p">.</span>

<span class="nx">The</span> <span class="nx">source</span> <span class="nx">code</span> <span class="nx">here</span> <span class="o">is</span> <span class="nx">written</span> <span class="nx">as</span> <span class="nx">an</span> <span class="nx">experiment</span> <span class="k">of</span> <span class="nx">literate</span> <span class="nx">programming</span>
<span class="nx">Which</span> <span class="nx">means</span> <span class="nx">you</span> <span class="nx">would</span> <span class="nx">be</span> <span class="nx">able</span> <span class="nx">to</span> <span class="nx">understand</span> <span class="nx">it</span><span class="p">,</span> <span class="nx">without</span> <span class="nx">knowing</span> <span class="nx">code</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Require the file system module for node.js
This provides us with what we need to interact with the file system (aka files and directories)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">fs = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Let's set the debugging mode
We will use this later on when outputting messages that make our code easier to debug
Note: when we publish the module, we want to set this as off, as we don't want the application using us
 to spurt our all our debug messages!</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">debug = </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Now to make watching files more convient and managed, we'll create a class which we can use to attach to each file
It'll provide us with the API and abstraction we need to accomplish difficult things like recursion
We'll also store a global store of all the watchers and their paths so we don't have multiple watchers going at the same time
 for the same file - as that would be quite ineffecient</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">watchers = </span><span class="p">{}</span>
<span class="nv">Watcher = </span><span class="k">class</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>The path this class instance is attached to</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">path: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Is it a directory or not?</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">isDirectory: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Our fs.stat object, it contains things like change times, size, and is it a directory</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">stat: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>The events that we will trigger when we detect a change
We make this as an array as otherwise we would have to have one listener for every event
 as that would be quite slow
So instead we have one listener, with many events</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">events: </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>The node.js file watcher instance, we have to open and close this, it is what notifies us of the events</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">fswatcher: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>We also want to setup a delay between change events, as if we changed a lot of files,
 we just want to be notified once, instead of like 1000 times</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">timeout: </span><span class="kc">null</span>
	<span class="nv">delay: </span><span class="mi">500</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>The watchers for the children of this watcher will go here
This is for when we are watching a directory, we will scan the directory and children go here</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">children: </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>We have to store the current state of the watcher and it is asynchronous (things can fire in any order)
as such, we don't want to be doing particular things if this watcher is deactivated (closed)</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">state: </span><span class="s1">&#39;pending&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>The method we will use to watch the files
Preferably we use watchFile, however we may need to use watch in case watchFile doesn't exist (e.g. windows)</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">method: </span><span class="kc">null</span>
	</pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Now it's time to construct our watcher
We give it a path, and give it some events to use
Then we get to work with watching it
next()</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">constructor: </span><span class="nf">(path,events=[],next) -&gt;</span>
		<span class="vi">@children = </span><span class="p">[]</span>
		<span class="vi">@events = </span><span class="p">[]</span>
		<span class="vi">@path = </span><span class="nx">path</span>
		<span class="nx">@addEvents</span> <span class="nx">events</span>
		<span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span> <span class="nx">@path</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">stat</span><span class="p">)</span> <span class="o">=&gt;</span>
			<span class="k">return</span>  <span class="k">if</span> <span class="nx">@state</span> <span class="o">is</span> <span class="s1">&#39;closed&#39;</span>
			<span class="k">throw</span> <span class="nx">err</span>  <span class="k">if</span> <span class="nx">err</span>
			<span class="vi">@stat = </span><span class="nx">stat</span>
			<span class="vi">@isDirectory = </span><span class="nx">stat</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">()</span>
			<span class="nx">@watch</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span>
	</pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Let's now add our events
We should support being passed a list of events, as well as one event, or no events (for error prevention)
We should also not add an event if it is already added</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">addEvents: </span><span class="nf">(events) -&gt;</span>
		<span class="nx">unless</span> <span class="nx">events</span> <span class="k">instanceof</span> <span class="nb">Array</span>
			<span class="k">if</span> <span class="nx">events</span>
				<span class="nv">events = </span><span class="p">[</span><span class="nx">events</span><span class="p">]</span>
			<span class="k">else</span>
				<span class="nv">events = </span><span class="p">[]</span>
		<span class="k">for</span> <span class="nx">event</span> <span class="k">in</span> <span class="nx">events</span>
			<span class="nv">found = </span><span class="kc">false</span>
			<span class="k">for</span> <span class="nx">storedEvent</span> <span class="k">in</span> <span class="nx">@events</span>
				<span class="k">if</span> <span class="nx">storedEvent</span> <span class="o">is</span> <span class="nx">event</span>
					<span class="nv">found = </span><span class="kc">true</span>
					<span class="k">break</span>
			<span class="k">if</span> <span class="o">not</span> <span class="nx">found</span>
				<span class="nx">@events</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span>
		<span class="err">@</span>
	</pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Before we start watching, we'll have to setup the functions our watcher will need</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>It will need function to trigger all of our watcher's events</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">trigger: </span><span class="o">-&gt;</span>
		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;trigger: #{@path}&quot;</span>  <span class="k">if</span> <span class="nx">debug</span>
		<span class="k">for</span> <span class="nx">event</span> <span class="k">in</span> <span class="nx">@events</span>
			<span class="nx">event</span><span class="p">()</span>
		<span class="err">@</span>
	</pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>We also need something so when a file is changed, we wait a while until things have calmed down
 and once they have calmed down, then trigger our events</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">changed: </span><span class="o">-&gt;</span>
		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;changed: #{@path}&quot;</span>  <span class="k">if</span> <span class="nx">debug</span>
		<span class="k">if</span> <span class="nx">@timeout</span>
			<span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">@timeout</span><span class="p">)</span>
			<span class="vi">@timeout = </span><span class="kc">false</span>
		<span class="vi">@timeout = </span><span class="nx">setTimeout</span><span class="p">(</span>
			<span class="o">=&gt;</span> <span class="nx">@trigger</span><span class="p">()</span>
			<span class="nx">@delay</span>
		<span class="p">)</span>
		<span class="err">@</span>
	</pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>We will need something to close our listener for removed or renamed files
As renamed files are a bit difficult we will want to close and delete all the watchers for all our children too
Essentially it is like a self-destruct without the body parts</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">close: </span><span class="o">-&gt;</span>
		<span class="k">return</span> <span class="err">@</span>  <span class="k">if</span> <span class="nx">@state</span> <span class="o">is</span> <span class="s1">&#39;closed&#39;</span>
		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;close: #{@path}&quot;</span>  <span class="k">if</span> <span class="nx">debug</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Close and destroy children</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">for</span> <span class="nx">watcher</span><span class="p">,</span><span class="nx">index</span> <span class="k">in</span> <span class="nx">@children</span>
			<span class="nx">watcher</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
			<span class="k">delete</span> <span class="nx">@children</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
		<span class="vi">@children = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Close ourself</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">@state</span> <span class="o">isnt</span> <span class="s1">&#39;closed&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Close listener</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">@method</span> <span class="o">is</span> <span class="s1">&#39;watchFile&#39;</span>
				<span class="nx">fs</span><span class="p">.</span><span class="nx">unwatchFile</span> <span class="nx">@path</span>
			<span class="k">else</span> <span class="k">if</span> <span class="nx">@method</span> <span class="o">is</span> <span class="s1">&#39;watch&#39;</span>  <span class="o">and</span>  <span class="nx">@fswatcher</span>
				<span class="nx">@fswatcher</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
				<span class="vi">@fswatcher = </span><span class="kc">null</span>
				</pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Updated state</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="vi">@state = </span><span class="s1">&#39;closed&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Delete our watchers reference</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">delete</span> <span class="nx">watchers</span><span class="p">[</span><span class="nx">@path</span><span class="p">]</span>  <span class="k">if</span> <span class="nx">watchers</span><span class="p">[</span><span class="nx">@path</span><span class="p">]</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Chain</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="err">@</span>
	</pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>We need something to figure out what to do when a file is changed
It will check if we are still active, and if so, then handle the fs.watchFile event</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">handlerWatchFile: </span><span class="nf">(curr,prev) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Log</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;handlerWatchFile: #{@path}&quot;</span>  <span class="k">if</span> <span class="nx">debug</span>
		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">arguments</span>  <span class="k">if</span> <span class="nx">debug</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Ignore if we are closed</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">return</span>  <span class="k">if</span> <span class="nx">@state</span> <span class="o">is</span> <span class="s1">&#39;closed&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Handle fs.watchFile event</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">return</span>  <span class="k">if</span> <span class="nx">curr</span><span class="p">.</span><span class="nx">mtime</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">is</span> <span class="nx">prev</span><span class="p">.</span><span class="nx">mtime</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span>  <span class="o">and</span>  <span class="nx">curr</span><span class="p">.</span><span class="nx">size</span> <span class="o">is</span> <span class="nx">prev</span><span class="p">.</span><span class="nx">size</span>
		<span class="nx">@changed</span><span class="p">()</span>
		<span class="nx">@watch</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Done</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">return</span>
	</pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>We need something to figure out what to do when a file is changed
It will check if we are still active, and if so, then handle the fs.watch event</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">handlerWatch: </span><span class="nf">(event,filename) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Log</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;handlerWatch: #{@path}&quot;</span>  <span class="k">if</span> <span class="nx">debug</span>
		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">arguments</span>  <span class="k">if</span> <span class="nx">debug</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Ignore if we are closed</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">return</span>  <span class="k">if</span> <span class="nx">@state</span> <span class="o">is</span> <span class="s1">&#39;closed&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Ignore if what changed was a hidden file</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">return</span>  <span class="k">if</span> <span class="nx">filename</span> <span class="o">and</span> <span class="sr">/^[\.~]/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">filename</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Renames and new files
If we are a file then stop our close our watcher, as an event will also have fired for the parent directory
If we are the parent directory, then trigger our change event,
 then re-initialise all our listernes, as we want to close listerners for deleted files
 and add new listeners for added files</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">event</span> <span class="o">is</span> <span class="s1">&#39;rename&#39;</span>
			<span class="k">if</span> <span class="nx">@isDirectory</span> <span class="o">is</span> <span class="kc">false</span>
				<span class="nx">@close</span><span class="p">()</span>
			<span class="k">else</span>
				<span class="nx">@changed</span><span class="p">()</span>
				<span class="k">try</span>
					<span class="nx">@watch</span><span class="p">()</span>
			</pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Changed files
If we were a change, then let's check that something did actually change
If it did, then trigger our change event</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">else</span> <span class="k">if</span> <span class="nx">event</span> <span class="o">is</span> <span class="s1">&#39;change&#39;</span>
			<span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span> <span class="nx">@path</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">stat</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Ignore if we are closed</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">return</span>  <span class="k">if</span> <span class="nx">@state</span> <span class="o">is</span> <span class="s1">&#39;closed&#39;</span>
				<span class="k">throw</span> <span class="nx">err</span>  <span class="k">if</span> <span class="nx">err</span>
				<span class="k">return</span>  <span class="k">if</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">mtime</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">is</span> <span class="nx">@stat</span><span class="p">.</span><span class="nx">mtime</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span>  <span class="o">and</span>  <span class="nx">stat</span><span class="p">.</span><span class="nx">size</span> <span class="o">is</span> <span class="nx">@stat</span><span class="p">.</span><span class="nx">size</span>
				<span class="vi">@stat = </span><span class="nx">stat</span>
				<span class="nx">@changed</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Done</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">return</span>
	</pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Setup the watching for our path
If we are already watching this path then let's start again (call close)
Then if we are a directory, let's recurse
Finally, let's initialise our node.js watcher that'll let us know when things happen
and update our state to active</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">watch: </span><span class="nf">(next) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Prepare</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">@close</span><span class="p">()</span>
		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;watch: #{@path}&quot;</span>  <span class="k">if</span> <span class="nx">debug</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Tasks</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">completed = </span><span class="mi">0</span>
		<span class="nv">expected = </span><span class="mi">2</span>
		<span class="nv">complete = </span><span class="o">-&gt;</span>
			<span class="o">++</span><span class="nx">completed</span>
			<span class="k">if</span> <span class="nx">completed</span> <span class="o">is</span> <span class="nx">expected</span>
				<span class="nx">next</span><span class="o">?</span><span class="p">()</span>
		</pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Cycle through the directory if necessary</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">@isDirectory</span>
			<span class="nx">fs</span><span class="p">.</span><span class="nx">readdir</span> <span class="nx">@path</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">files</span><span class="p">)</span> <span class="o">=&gt;</span>
				<span class="k">throw</span> <span class="nx">err</span>  <span class="k">if</span> <span class="nx">err</span>
				<span class="nx">expected</span> <span class="o">+=</span> <span class="nx">files</span><span class="p">.</span><span class="nx">length</span>
				<span class="nx">complete</span><span class="p">()</span>
				<span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">files</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Ignore hidden files/dirs</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="k">if</span> <span class="sr">/^[\.~]/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">file</span>
						<span class="o">--</span><span class="nx">expected</span>
						<span class="k">continue</span>
					</pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Watch the file/dir</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="nv">filePath = </span><span class="nx">@path</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="nx">file</span>
					<span class="nv">watcher = </span><span class="nx">watch</span><span class="p">(</span>
						<span class="nx">filePath</span>
						<span class="o">=&gt;</span>
							<span class="nx">@changed</span><span class="p">()</span>
						<span class="nx">complete</span>
					<span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Store the child watchr in us</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="nx">@children</span><span class="p">.</span><span class="nx">push</span> <span class="nx">watcher</span>
		<span class="k">else</span>
			<span class="nx">complete</span><span class="p">()</span>
		</pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Watch the current file/directory</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">try</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Try first with fs.watchFile</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">fs</span><span class="p">.</span><span class="nx">watchFile</span> <span class="nx">@path</span><span class="p">,</span> <span class="p">(</span><span class="nx">args</span><span class="p">...)</span> <span class="o">=&gt;</span>
				<span class="nx">@handlerWatchFile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="err">@</span><span class="p">,</span><span class="nx">args</span><span class="p">)</span>
			<span class="vi">@method = </span><span class="s1">&#39;watchFile&#39;</span>
		<span class="k">catch</span> <span class="nx">err</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Then try with fs.watch</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="vi">@fswatcher = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">watch</span> <span class="nx">@path</span><span class="p">,</span> <span class="p">(</span><span class="nx">args</span><span class="p">...)</span> <span class="o">=&gt;</span>
				<span class="nx">@handlerWatch</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="err">@</span><span class="p">,</span><span class="nx">args</span><span class="p">)</span>
			<span class="vi">@method = </span><span class="s1">&#39;watch&#39;</span>
		</pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>We are now watching so set the state as active</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="vi">@state = </span><span class="s1">&#39;active&#39;</span>
		<span class="nx">complete</span><span class="p">()</span>
		<span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Provide our interface to the applications that use watchr
This will create our new Watcher class for the path we want
 (or use an existing one, and add the events)
Watcher also uses this too</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">watch = </span><span class="nf">(path,events,next) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Check if we are already watching that path</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">if</span> <span class="nx">watchers</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>We do, so let's use that one instead</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">watchers</span><span class="p">[</span><span class="nx">path</span><span class="p">].</span><span class="nx">addEvents</span><span class="p">(</span><span class="nx">events</span><span class="p">)</span>
		<span class="nx">next</span><span class="o">?</span><span class="p">()</span>
	<span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>We don't, so let's create a new one</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">watchers</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Watcher</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span><span class="nx">events</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Now let's provide node.js with our public API
In other words, what the application that calls us has access to</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">module.exports = </span><span class="p">{</span><span class="nx">watch</span><span class="p">}</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 